package xmss

import (
	"crypto/x509"
	"encoding/hex"
	"encoding/pem"
	"strings"
	"testing"
)

const certPEM  = `
-----BEGIN CERTIFICATE-----
MIICwTCCAmigAwIBAgIGAWgeY7QzMAoGCCqGSM49BAMCMHMxCzAJBgNVBAYTAlVT
MRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1TYW4gRnJhbmNpc2NvMRkw
FwYDVQQKExBvcmcxLmV4YW1wbGUuY29tMRwwGgYDVQQDExNjYS5vcmcxLmV4YW1w
bGUuY29tMB4XDTE5MDEwNTE0MjExN1oXDTIwMDEwNTE0MjExN1owajELMAkGA1UE
BhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBGcmFuY2lz
Y28xDTALBgNVBAsTBHBlZXIxHzAdBgNVBAMTFnBlZXIwLm9yZzEuZXhhbXBsZS5j
b20wbzAhBgorBgEEAYGwGgICMBMCAQACAQowCwYJYIZIAWUDBAIBA0oAMEcCAQAE
IJonhWzl1rkVxzTQFlrsz+m+vJVHiv3bOMdRqaOWaeV1BCDHFKxxnI0CrQMTId5k
Q25ANAa/PSFO+hFBqonE8QgaaqOB2jCB1zAJBgNVHRMEAjAAMA4GA1UdDwEB/wQE
AwIHgDCBuQYDVR0jBIGxMIGugCAQJy0Sp8Bjy4HQAH9zUMQeFLP6EOPtajVoJDrn
y1YWk6F3pHUwczELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAU
BgNVBAcTDVNhbiBGcmFuY2lzY28xGTAXBgNVBAoTEG9yZzEuZXhhbXBsZS5jb20x
HDAaBgNVBAMTE2NhLm9yZzEuZXhhbXBsZS5jb22CEQDEXikOb223fUcLWj7yicTm
MAoGCCqGSM49BAMCA0cAMEQCICy8jyorpSPQXDXNkt4x7vlNDz6gCr6dHmrg5e57
YCqLAiBaJUZL8vzWCNWPR4Oe71XcVyqRA8RiEieDPo6u6KbE8w==
-----END CERTIFICATE-----
`

const privateKey = `
-----BEGIN PRIVATE KEY-----
MIIJUQIBADAhBgorBgEEAYGwGgICMBMCAQACAQowCwYJYIZIAWUDBAIBBIIJJzCC
CSMCAQAwgYsCAQAEIFXKNqKUb0snr/EGwbOAafrUeqH6IavHKuR3N8n3cJ+oBCBs
JmtcktWuDbtmmvZv94574YsZbb+vSS3yh8yzQ8+FRwQgmieFbOXWuRXHNNAWWuzP
6b68lUeK/ds4x1Gpo5Zp5XUEIMcUrHGcjQKtAxMh3mRDbkA0Br89IU76EUGqicTx
CBpqoIIIjgSCCIqs7QAFc3IAJG9yZy5ib3VuY3ljYXN0bGUucHFjLmNyeXB0by54
bXNzLkJEUwAAAAAAAAABAgAKSQAFaW5kZXhJAAFrSQAKdHJlZUhlaWdodFoABHVz
ZWRMABJhdXRoZW50aWNhdGlvblBhdGh0ABBMamF2YS91dGlsL0xpc3Q7TAAEa2Vl
cHQAD0xqYXZhL3V0aWwvTWFwO0wABnJldGFpbnEAfgACTAAEcm9vdHQAK0xvcmcv
Ym91bmN5Y2FzdGxlL3BxYy9jcnlwdG8veG1zcy9YTVNTTm9kZTtMAAVzdGFja3QA
EUxqYXZhL3V0aWwvU3RhY2s7TAARdHJlZUhhc2hJbnN0YW5jZXNxAH4AAXhwAAAA
AAAAAAIAAAAKAXNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARz
aXpleHAAAAAKdwQAAAAKc3IAKW9yZy5ib3VuY3ljYXN0bGUucHFjLmNyeXB0by54
bXNzLlhNU1NOb2RlAAAAAAAAAAECAAJJAAZoZWlnaHRbAAV2YWx1ZXQAAltCeHAA
AAAAdXIAAltCrPMX+AYIVOACAAB4cAAAACB9egJHouubPD47yG5U404ufF3+urCl
c2dz0YLSsYCfEHNxAH4ACAAAAAF1cQB+AAsAAAAgi2+OvM9PwBvoodiw57NBRD8n
hHRvh9EIlYJp9jsjKZ1zcQB+AAgAAAACdXEAfgALAAAAIJrTo11DOd5siHzr2YOG
Z0j6JfNgsYVVG5cWp6rWEwyGc3EAfgAIAAAAA3VxAH4ACwAAACB1DWDjdFar4tSd
/sipAwhp46x8WM58bWJGtLlxV6ZjJnNxAH4ACAAAAAR1cQB+AAsAAAAg3fMSaLs3
YVBvDzaKujlyngIdMHmN4zssPHIm0XaiCsJzcQB+AAgAAAAFdXEAfgALAAAAIAoB
WJyuejXkONkExrm9gJ2xaWdK98knsNid+yZa7gLlc3EAfgAIAAAABnVxAH4ACwAA
ACACfG0d2GOo1fIjCjrw8G8pWY54ULBZzVOOVrtTLYGJb3NxAH4ACAAAAAd1cQB+
AAsAAAAgBqU1xM0QblcVuKkUD9Kf1uhtLwLUx1Npw9raYP2n4ZRzcQB+AAgAAAAI
dXEAfgALAAAAIC2lo4pcHohNsTroV9PWnd6O4n108Q2JkEUhKy7gMJ8Fc3EAfgAI
AAAACXVxAH4ACwAAACBB6ZD5RvQlZKvo/epzVx9OV591E3erW6ETFs+bmGn+jXhz
cgARamF2YS51dGlsLlRyZWVNYXAMwfY+LSVq5gMAAUwACmNvbXBhcmF0b3J0ABZM
amF2YS91dGlsL0NvbXBhcmF0b3I7eHBwdwQAAAAAeHNxAH4AH3B3BAAAAAFzcgAR
amF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFu
Zy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAACHNyABRqYXZhLnV0aWwuTGlua2VkTGlz
dAwpU11KYIgiAwAAeHB3BAAAAAFzcQB+AAgAAAAIdXEAfgALAAAAIBJ5Jxjx7t8i
od0YcsrhzVDyp6BWFXMmqVKyBG5EQ3UVeHhzcQB+AAgAAAAKdXEAfgALAAAAIMcU
rHGcjQKtAxMh3mRDbkA0Br89IU76EUGqicTxCBpqc3IAD2phdmEudXRpbC5TdGFj
axD+KsK7CYYdAgAAeHIAEGphdmEudXRpbC5WZWN0b3LZl31bgDuvAQMAA0kAEWNh
cGFjaXR5SW5jcmVtZW50SQAMZWxlbWVudENvdW50WwALZWxlbWVudERhdGF0ABNb
TGphdmEvbGFuZy9PYmplY3Q7eHAAAAAAAAAAAHVyABNbTGphdmEubGFuZy5PYmpl
Y3Q7kM5YnxBzKWwCAAB4cAAAAApwcHBwcHBwcHBweHNxAH4ABgAAAAh3BAAAAAhz
cgAsb3JnLmJvdW5jeWNhc3RsZS5wcWMuY3J5cHRvLnhtc3MuQkRTVHJlZUhhc2gA
AAAAAAAAAQIABloACGZpbmlzaGVkSQAGaGVpZ2h0SQANaW5pdGlhbEhlaWdodFoA
C2luaXRpYWxpemVkSQAJbmV4dEluZGV4TAAIdGFpbE5vZGVxAH4AA3hwAQAAAAAA
AAAAAAAAAABzcQB+AAgAAAAAdXEAfgALAAAAIM/DUAP80EzYJxOcGmcZ/cONYQbv
EbovXTtTXXEAe42pc3EAfgAzAQAAAAEAAAABAAAAAABzcQB+AAgAAAABdXEAfgAL
AAAAIELMf4ecSy0+loRo6E0FbG6CvdL9+L69ktjey4Y5RRChc3EAfgAzAQAAAAIA
AAACAAAAAABzcQB+AAgAAAACdXEAfgALAAAAIImlY4deifA4MRU/RPQYE2Pyyv8R
sUfZjo9ZLU8v/TQNc3EAfgAzAQAAAAMAAAADAAAAAABzcQB+AAgAAAADdXEAfgAL
AAAAIId+ArCer9vJbGQf5ktKhyV5TGRGgHn9picWA1Yy2TfKc3EAfgAzAQAAAAQA
AAAEAAAAAABzcQB+AAgAAAAEdXEAfgALAAAAIGnXJu8HH+OKRA1d5bOQmxusEH22
cwbtdRzs5z5emo73c3EAfgAzAQAAAAUAAAAFAAAAAABzcQB+AAgAAAAFdXEAfgAL
AAAAIJhU7QA/w4hf7mX36FM/6OJp9kv9r3a9x4AR1f7WQTp2c3EAfgAzAQAAAAYA
AAAGAAAAAABzcQB+AAgAAAAGdXEAfgALAAAAIMxcbPFFevruzQDK9SItBxt9t6ZI
9lVf0N5YmJioT8Ybc3EAfgAzAQAAAAcAAAAHAAAAAABzcQB+AAgAAAAHdXEAfgAL
AAAAIA71zHBMWQfLtSzTneezmaOiwl1+Y8TtoYP0LPj8KuAheA==
-----END PRIVATE KEY-----
`

func TestParsePKCS8PrivateKey(t *testing.T) {
	pemKey, _ := pem.Decode([]byte(privateKey))
	key, err := ParsePKCS8PrivateKey(pemKey.Bytes)
	if err != nil {
		t.Errorf("failed parsing PKCS8 private key: %v\n", err)
	}
	privateKey := key.(*PrivateKey)

	if strings.ToUpper(hex.EncodeToString(privateKey.root)) != "C714AC719C8D02AD031321DE64436E403406BF3D214EFA1141AA89C4F1081A6A" {
		t.Errorf("PrivateKey is not correct -> root: %X", privateKey.root)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.publicSeed)) != "9A27856CE5D6B915C734D0165AECCFE9BEBC95478AFDDB38C751A9A39669E575" {
		t.Errorf("PrivateKey is not correct -> publicSeed: %X", privateKey.publicSeed)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.msgPRF.seed)) != "6C266B5C92D5AE0DBB669AF66FF78E7BE18B196DBFAF492DF287CCB343CF8547" {
		t.Errorf("PrivateKey is not correct -> secretKeyPRF: %X", privateKey.msgPRF.seed)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.wotsPRF.seed)) != "55CA36A2946F4B27AFF106C1B38069FAD47AA1FA21ABC72AE47737C9F7709FA8" {
		t.Errorf("PrivateKey is not correct -> secretKeySeed: %X", privateKey.wotsPRF.seed)
	}
	if privateKey.m.leaf != 0 {
		t.Errorf("PrivateKey is not correct -> Index: %d", privateKey.m.leaf)
	}
}

func TestParseXMSSKeys(t *testing.T) {
	pemKey, _ := pem.Decode([]byte(privateKey))
	key, err := ParsePKCS8PrivateKey(pemKey.Bytes)
	if err != nil {
		t.Errorf("failed parsing PKCS8 private key: %v\n", err)
	}
	privateKey := key.(*PrivateKey)

	if strings.ToUpper(hex.EncodeToString(privateKey.root)) != "C714AC719C8D02AD031321DE64436E403406BF3D214EFA1141AA89C4F1081A6A" {
		t.Errorf("PrivateKey is not correct -> root: %X", privateKey.root)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.publicSeed)) != "9A27856CE5D6B915C734D0165AECCFE9BEBC95478AFDDB38C751A9A39669E575" {
		t.Errorf("PrivateKey is not correct -> publicSeed: %X", privateKey.publicSeed)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.msgPRF.seed)) != "6C266B5C92D5AE0DBB669AF66FF78E7BE18B196DBFAF492DF287CCB343CF8547" {
		t.Errorf("PrivateKey is not correct -> secretKeyPRF: %X", privateKey.msgPRF.seed)
	}
	if strings.ToUpper(hex.EncodeToString(privateKey.wotsPRF.seed)) != "55CA36A2946F4B27AFF106C1B38069FAD47AA1FA21ABC72AE47737C9F7709FA8" {
		t.Errorf("PrivateKey is not correct -> secretKeySeed: %X", privateKey.wotsPRF.seed)
	}
	if privateKey.m.leaf != 0 {
		t.Errorf("PrivateKey is not correct -> Index: %d", privateKey.m.leaf)
	}

	pemCert, _ := pem.Decode([]byte(certPEM))
	cert, err := x509.ParseCertificate(pemCert.Bytes)
	if err != nil {
		t.Errorf("failed parsing x509 certificate: %v\n", err)
	}
	key, err = ParsePKIXPublicKey(cert.RawSubjectPublicKeyInfo)
	if err != nil {
		t.Errorf("failed parsing PKIX public key: %v\n", err)
	}

	publicKey := key.(*PublicKey)
	if publicKey.Height != 10 {
		t.Errorf("Height is not 10: %d", publicKey.Height)
	}
	if strings.ToUpper(hex.EncodeToString(publicKey.root)) != "C714AC719C8D02AD031321DE64436E403406BF3D214EFA1141AA89C4F1081A6A" {
		t.Errorf("PrivateKey is not correct -> root: %X", publicKey.root)
	}
	if strings.ToUpper(hex.EncodeToString(publicKey.publicSeed)) != "9A27856CE5D6B915C734D0165AECCFE9BEBC95478AFDDB38C751A9A39669E575" {
		t.Errorf("PrivateKey is not correct -> publicSeed: %X", publicKey.publicSeed)
	}

	sig := privateKey.Sign([]byte("Test Nachricht"))
	exSig := "000000009EF61C4FCB0A796188EE7DB4035952CC8128F0B791511CA1602757968D2F1A2634FA45456AB2857CC69F9098E53A06FFAD773D5228686BCC0777313E11C128E0AD797791B447D1BF468EA53957684365C229F37E311826AECFCF34FF80A23A344FD69F38F28C475613E9627833519D31A55FD6263588042B7D5E653B084E6E3FF1F26BEC43025634DA84CC9EB9A1D1C6B53CA2B2C05F4B9DE7313897A70FF659E14A9442EF19024E68DB96703A882767AABBAD1EC05574BEF961EC166299EEBF513285E3CD84F798A6FC6C1105AAD95736C05ED29A0D1BBD63457B839197EAF563EC0DB16579207C1156C6B1EF1EDB276F198C892DA6210B796FEF0941E8F0060519D9387E6E8BA7778DD1E3F8574E42AD215BDC2D1040D489EE39C1A564130D7819BB229BB4C280AC50F5B8F88BCAB9E40F4C9F4FECE8628C777713B2DEE00D295D2196F8A706544700C45D837E11FDBFF2347FE65A22221ADF14104FA7AB6289753B7A9C74F7FEDD3C1F7C4CE5802A341E0DE31BB90C61671A835FB58A631C04EAD9B7B6370CAF4BC6CF4C055A5F8E3A375EB677356228421E9C38E824D5FF9A098D0BE62DB3431A48220AE35C791161274E2DCC8FD82480BB50DB059564EA705062939B34EFEE01E18DCD6A12A2A18AF94FD0EB54133699E9C7F42E20560010FB8C63544D59A46464EB03354932E1C6502E8B5F9A777338F80403E193E048B562B7F5C25E3FA320E7BECE30D363F0D32ED6F08402515C109EFCBEF5EDBF740E9BACDC475C0034327604EA4171E0EF477A7438380A10A5F97CF1D9756020C90394D8F3B617BF27EA465DD0A73383CAF1A6193152E68B7A4B26B62BB9F24329F493EBD4A618083B9E5D276D6B3DF949E814EE5611D808FF4D26ECFD1101B8EDE367D8EC245EC3CFEABE4C384FD44349509226BA2F74149E6CD33DEA730A1EAF116E7C346321452250246CE56F15569307FB55C9827562A6776AAA8CC27EAB62D61A643F401C9FF773ABBC27B3E0946DC140C9B211A9E5ED30B1D0F1DF748A09B1BF0E4FE60005E452C48A7BB55C22FA1CAD8D1D8D986B449E5BAE6127ADAA66AFE60D4B224794B0F6DCDC96AFACC84C3BC07D8EF2447E676B7028DA2815A6C946B3D71F327E0CB90E7B78DFE4D67D1BFB9015AD56273E446956A2D97A0EEE2439FAFE67FB9C476DF1CABDBE93701063B62DA974556BEFF076E693F4ACDFF869FFCB0892CC69B47683827186E77929ABCCA46E335ECC3ADC21159D4FAE28FD8AF6B254FD4BEF1AF08BD66C3037ED6F01ADDC6022424B31B96D93B96D1E3F1AF53A4CE3FC52CF2046B83B1943C27BEA642C50F115C788F9D7225044DAAFFC4FB19C91736F2F0F3704796A9FB38B58614BF685C2E2E22040FCEE8A9D01C58938E55959A08CC0FCA261F624192E37CA807952B054007C5E5F499A4519C51A5B3E06EFF16B6FF8546A3B8620502FF39CE72CD0C3E922EAA1518FDDD4AD5D8BD6C5FE103055974BB42F258E007F9065BE6E57CAB3FB4D772E02241A25563076A76C01CD95317AA7DD0B64E0B1338C5FEB2930CD288EBC68F97D18FB3B6DA36A68EF80D36ED3EE3BD31FFCE4B869A7B937DA86A36E5A137BB7FADB09A696A1CC51CA42BA7FFBCC685A282464FD703809EF045A5A6706D3BAEA43CFCE31689ECB15DBA28210AC7330028EC7733152E84B8852B926A854E356824AD14F9DF82AC992EBCA458DD0662C2416C98B0F0B6DA4F261D1845B9CEEDDA8D2239227DABDBB5BBB58D921240319099A560FED67C624A4851BA80D178CD0FA99D4071260243246A6E0F819FA0195C19A338DC394D6B2A42DEE4D8791727D10E83CFC2C5633532EC08414437D0FCA995E62842CB3C8BA5A1234D98DDE2DD12DAAB5C29A031E41D4082763FD3F603351E046C60838935F6DBF28B243F7CCABF8207ABA48ECCE1384183001F574B69323FB230B58C4D5DE8365EAF5B82180078A6DCE803C7EA7AB78C1E10AD2ECD3D2B2A95B4E69A05107C0467C39EB90013C7DA270EC4D04A8F9FA1F2A3357E7B38ACD5CF38ACC10DDABFB27E8BE697A3A088C82772BD836834486FF82CA458B9CAE89A2ECE7671E140710D407A0F5B66F72785C56F173AF4ABB66E653A8942620080B4BC65A0523C0B04EC4688F842E82B567951AEFB24853FCB9C4678852A9133108A11B6FB4C555042BA0E7153E612EC054CD8DC852C061E80437E641200BF1EB933E6EE881837E0F4E9DD6C731AAABA07D860607960892436175998796415C02D89C3AD521E4C7CBCC34013ED2DE8C828B6D796AF38BB77FC9B713546315B15A5871D389F9BBDD857881AFB0EA994FF37828685F3769B6D2CC080EFED652B653B6C7CD01B166A3475D44D8334B6040DFCF60087980E0B13E747821BE4EDFC88A49D1602E109E145E398F68C92070FFEA7538E3DC8AC1582B2A34129F0BE9A842DF6BB1B473F4AE17E1DA6240DEF1D3E262ED9798F2C3DC53BBBE6ABA251BEE281B9054B12949FDED41B7A746C2C7EFD807E0E88F4ED97343E7F6A26BCD32A6DD65E92C0979D397773384B373FBC266F399C1E3B114A91A3272D0DA48FF0188A4BAC079801ECBBC97E9D7F768E1E177C8D9019AF76F1979BFF77E62897EC933638FD192CAC46FAF93432FB844B207DE084A9E410BCD0DEAF1713F53942E994F9940B75F7C7FD3B90A7187E861ADFBA6368A9E2529F7637456D2FED115F411F6DF24FC5B5354FA240762B974168897D8B0B1E7C69A8C6812D48ED592EA1B9301CA50F0B493F2ED185789E04EA3F8E9CC3D230688645CCE05196631501CCBBAF6BD50319216949B1D2886FFA93EFB68B49F007E88C5F57738F24361D51BFBAF8DE9672B95494C66BE85E72A9F63C6C58E2B0A4227665CD1647414A07E2C56783D08CDB90E1C86E178DC6422A36F7FC8179108B2B98A4714F66AD340B07D0028CFCDD3B4F9BA803E5C09C9FAA939B7F493C2C72430F835A4CC0EB22A0E65FF903E148778D8DF50EB45563E9C6B0964D10ACB92BED21EF1C19CD236EF0529522BBBC18AED52CBD8FE5848D3CFAE6CEACB2F60AA1AAF108BE067AD94EF347D7A0247A2EB9B3C3E3BC86E54E34E2E7C5DFEBAB0A5736773D182D2B1809F108B6F8EBCCF4FC01BE8A1D8B0E7B341443F2784746F87D108958269F63B23299D9AD3A35D4339DE6C887CEBD983866748FA25F360B185551B9716A7AAD6130C86750D60E37456ABE2D49DFEC8A9030869E3AC7C58CE7C6D6246B4B97157A66326DDF31268BB3761506F0F368ABA39729E021D30798DE33B2C3C7226D176A20AC20A01589CAE7A35E438D904C6B9BD809DB169674AF7C927B0D89DFB265AEE02E5027C6D1DD863A8D5F2230A3AF0F06F29598E7850B059CD538E56BB532D81896F06A535C4CD106E5715B8A9140FD29FD6E86D2F02D4C75369C3DADA60FDA7E1942DA5A38A5C1E884DB13AE857D3D69DDE8EE27D74F10D899045212B2EE0309F0541E990F946F42564ABE8FDEA73571F4E579F751377AB5BA11316CF9B9869FE8D"
	if strings.ToUpper(hex.EncodeToString(sig)) != exSig {
		t.Errorf("Signature is not correct: %T", sig)
	}

	if !publicKey.Verify(sig, []byte("Test Nachricht")) {
		t.Errorf("Verification failed")
	}

}


func TestParsePKIXPublicKey(t *testing.T) {
	pemCert, _ := pem.Decode([]byte(certPEM))
	cert, err := x509.ParseCertificate(pemCert.Bytes)
	if err != nil {
		t.Errorf("failed parsing x509 certificate: %v\n", err)
	}
	key, err := ParsePKIXPublicKey(cert.RawSubjectPublicKeyInfo)
	if err != nil {
		t.Errorf("failed parsing PKIX public key: %v\n", err)
	}

	publicKey := key.(*PublicKey)
	if publicKey.Height != 10 {
		t.Errorf("Height is not 10: %d", publicKey.Height)
	}
	if strings.ToUpper(hex.EncodeToString(publicKey.root)) != "C714AC719C8D02AD031321DE64436E403406BF3D214EFA1141AA89C4F1081A6A" {
		t.Errorf("PrivateKey is not correct -> root: %X", publicKey.root)
	}
	if strings.ToUpper(hex.EncodeToString(publicKey.publicSeed)) != "9A27856CE5D6B915C734D0165AECCFE9BEBC95478AFDDB38C751A9A39669E575" {
		t.Errorf("PrivateKey is not correct -> publicSeed: %X", publicKey.publicSeed)
	}
}